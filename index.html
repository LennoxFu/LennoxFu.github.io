<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excelç¿»è¯‘å·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #333;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      text-align: center;
      max-width: 800px;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 24px 24px 0 0;
    }

    h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 1.1rem;
      margin-bottom: 30px;
      font-weight: 400;
    }

    .upload-area {
      border: 3px dashed #bdc3c7;
      border-radius: 20px;
      padding: 40px 20px;
      margin: 30px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.5);
    }

    .upload-area:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .upload-area.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.2);
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3rem;
      color: #667eea;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 1.2rem;
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .upload-subtext {
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      min-width: 120px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .progress-container {
      margin: 30px 0;
      text-align: left;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      color: #2c3e50;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .file-info {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
      display: none;
    }

    .file-info h3 {
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .file-info p {
      color: #7f8c8d;
      margin: 5px 0;
    }

    .error-message {
      background: #e74c3c;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      display: none;
    }

    .success-message {
      background: #27ae60;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      display: none;
    }

    .settings {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .settings h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .setting-group {
      margin: 15px 0;
    }

    .setting-group label {
      display: block;
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .setting-group select,
    .setting-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ecf0f1;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .setting-group select:focus,
    .setting-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .upload-area {
        padding: 30px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Excelç¿»è¯‘å·¥å…·</h1>
    <p class="subtitle">ä¸Šä¼ Excelæ–‡ä»¶ï¼Œè‡ªåŠ¨å°†è‹±æ–‡å†…å®¹ç¿»è¯‘æˆä¸­æ–‡</p>

    <div class="settings">
      <h3>è®¾ç½®é€‰é¡¹</h3>
      <div class="setting-group">
        <label for="sourceColumn">æºè¯­è¨€åˆ—ï¼ˆå¦‚ï¼šAåˆ—ï¼‰:</label>
        <input type="text" id="sourceColumn" value="A" placeholder="ä¾‹å¦‚: A, B, C...">
      </div>
      <div class="setting-group">
        <label for="targetColumn">ç¿»è¯‘ç»“æœåˆ—ï¼ˆå¦‚ï¼šBåˆ—ï¼‰:</label>
        <input type="text" id="targetColumn" value="B" placeholder="ä¾‹å¦‚: B, C, D...">
      </div>
      <div class="setting-group">
        <label for="translationService">ç¿»è¯‘æœåŠ¡:</label>
        <select id="translationService">
          <option value="google">Googleç¿»è¯‘ï¼ˆå…è´¹ï¼‰</option>
          <option value="mymemory">MyMemoryï¼ˆå…è´¹ï¼‰</option>
        </select>
      </div>
    </div>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°è¿™é‡Œ</div>
      <div class="upload-subtext">æ”¯æŒ .xlsx, .xls æ ¼å¼</div>
      <input type="file" id="fileInput" accept=".xlsx,.xls">
    </div>

    <div class="file-info" id="fileInfo">
      <h3>æ–‡ä»¶ä¿¡æ¯</h3>
      <p id="fileName"></p>
      <p id="fileSize"></p>
      <p id="sheetCount"></p>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-text" id="progressText">å‡†å¤‡ç¿»è¯‘...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <button class="btn" id="translateBtn" disabled>å¼€å§‹ç¿»è¯‘</button>
    <button class="btn" id="downloadBtn" style="display: none;">ä¸‹è½½ç¿»è¯‘æ–‡ä»¶</button>
  </div>

  <script>
    class ExcelTranslator {
      constructor() {
        this.workbook = null;
        this.translatedWorkbook = null;
        this.initializeEventListeners();
      }

      initializeEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const translateBtn = document.getElementById('translateBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
        uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
        uploadArea.addEventListener('drop', this.handleDrop.bind(this));
        fileInput.addEventListener('change', this.handleFileSelect.bind(this));

        // æŒ‰é’®äº‹ä»¶
        translateBtn.addEventListener('click', this.translateFile.bind(this));
        downloadBtn.addEventListener('click', this.downloadFile.bind(this));
      }

      handleDragOver(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          this.processFile(files[0]);
        }
      }

      handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          this.processFile(file);
        }
      }

      processFile(file) {
        // éªŒè¯æ–‡ä»¶ç±»å‹
        if (!file.name.match(/\.(xlsx|xls)$/)) {
          this.showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰');
          return;
        }

        this.hideMessages();
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            this.workbook = XLSX.read(data, { type: 'array' });
            this.displayFileInfo(file);
            document.getElementById('translateBtn').disabled = false;
          } catch (error) {
            this.showError('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
          }
        };
        reader.readAsArrayBuffer(file);
      }

      displayFileInfo(file) {
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const sheetCount = document.getElementById('sheetCount');

        fileName.textContent = `æ–‡ä»¶å: ${file.name}`;
        fileSize.textContent = `æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
        sheetCount.textContent = `å·¥ä½œè¡¨æ•°é‡: ${this.workbook.SheetNames.length}`;

        fileInfo.style.display = 'block';
      }

      async translateFile() {
        if (!this.workbook) {
          this.showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶');
          return;
        }

        this.hideMessages();
        this.showProgress();
        
        document.getElementById('translateBtn').disabled = true;
        
        try {
          // åˆ›å»ºæ–°çš„å·¥ä½œç°¿
          this.translatedWorkbook = XLSX.utils.book_new();
          
          const sourceCol = document.getElementById('sourceColumn').value.toUpperCase();
          const targetCol = document.getElementById('targetColumn').value.toUpperCase();
          
          for (let i = 0; i < this.workbook.SheetNames.length; i++) {
            const sheetName = this.workbook.SheetNames[i];
            await this.translateSheet(sheetName, sourceCol, targetCol, i);
          }
          
          this.showSuccess('ç¿»è¯‘å®Œæˆï¼å¯ä»¥ä¸‹è½½ç¿»è¯‘åçš„æ–‡ä»¶äº†ã€‚');
          document.getElementById('downloadBtn').style.display = 'inline-block';
          
        } catch (error) {
          this.showError(`ç¿»è¯‘è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`);
        } finally {
          this.hideProgress();
          document.getElementById('translateBtn').disabled = false;
        }
      }

      async translateSheet(sheetName, sourceCol, targetCol, sheetIndex) {
        const worksheet = this.workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        this.updateProgress(`æ­£åœ¨ç¿»è¯‘å·¥ä½œè¡¨: ${sheetName}`, (sheetIndex / this.workbook.SheetNames.length) * 100);
        
        // åˆ›å»ºæ–°çš„æ•°æ®æ•°ç»„
        const translatedData = [];
        
        for (let rowIndex = 0; rowIndex < jsonData.length; rowIndex++) {
          const row = jsonData[rowIndex] || [];
          const newRow = [...row];
          
          // è·å–æºåˆ—çš„æ•°æ®
          const sourceColIndex = this.columnLetterToIndex(sourceCol);
          const targetColIndex = this.columnLetterToIndex(targetCol);
          
          if (row[sourceColIndex] && typeof row[sourceColIndex] === 'string') {
            const sourceText = row[sourceColIndex].trim();
            if (sourceText && this.isEnglish(sourceText)) {
              try {
                const translatedText = await this.translateText(sourceText);
                // ç¡®ä¿ç›®æ ‡åˆ—ä½ç½®å­˜åœ¨
                while (newRow.length <= targetColIndex) {
                  newRow.push('');
                }
                newRow[targetColIndex] = translatedText;
                
                // æ›´æ–°è¿›åº¦
                const totalProgress = (sheetIndex / this.workbook.SheetNames.length + 
                                    (rowIndex / jsonData.length) / this.workbook.SheetNames.length) * 100;
                this.updateProgress(`ç¿»è¯‘è¿›åº¦: ${rowIndex + 1}/${jsonData.length} è¡Œ`, totalProgress);
                
                // æ·»åŠ å»¶è¿Ÿä»¥é¿å…APIé™åˆ¶
                await this.delay(100);
              } catch (error) {
                console.warn(`ç¿»è¯‘å¤±è´¥ (è¡Œ ${rowIndex + 1}): ${error.message}`);
                newRow[targetColIndex] = `[ç¿»è¯‘å¤±è´¥: ${sourceText}]`;
              }
            }
          }
          
          translatedData.push(newRow);
        }
        
        // åˆ›å»ºæ–°çš„å·¥ä½œè¡¨
        const newWorksheet = XLSX.utils.aoa_to_sheet(translatedData);
        XLSX.utils.book_append_sheet(this.translatedWorkbook, newWorksheet, sheetName);
      }

      columnLetterToIndex(letter) {
        let result = 0;
        for (let i = 0; i < letter.length; i++) {
          result = result * 26 + (letter.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
        }
        return result - 1;
      }

      isEnglish(text) {
        // ç®€å•çš„è‹±æ–‡æ£€æµ‹ï¼šåŒ…å«è‹±æ–‡å­—æ¯
        return /[a-zA-Z]/.test(text) && !/[^\x00-\x7F]/.test(text);
      }

      async translateText(text) {
        const service = document.getElementById('translationService').value;
        
        if (service === 'google') {
          return await this.translateWithGoogle(text);
        } else {
          return await this.translateWithMyMemory(text);
        }
      }

      async translateWithGoogle(text) {
        // ä½¿ç”¨Googleç¿»è¯‘çš„å…è´¹APIï¼ˆé€šè¿‡ä»£ç†ï¼‰
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh&dt=t&q=${encodeURIComponent(text)}`;
        
        try {
          const response = await fetch(url);
          const data = await response.json();
          return data[0][0][0];
        } catch (error) {
          throw new Error('Googleç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
        }
      }

      async translateWithMyMemory(text) {
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|zh`;
        
        try {
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.responseStatus === 200) {
            return data.responseData.translatedText;
          } else {
            throw new Error('ç¿»è¯‘æœåŠ¡å“åº”é”™è¯¯');
          }
        } catch (error) {
          throw new Error('MyMemoryç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
        }
      }

      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      downloadFile() {
        if (!this.translatedWorkbook) {
          this.showError('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
          return;
        }

        try {
          const fileName = `ç¿»è¯‘ç»“æœ_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
          XLSX.writeFile(this.translatedWorkbook, fileName);
          this.showSuccess('æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼');
        } catch (error) {
          this.showError('æ–‡ä»¶ä¸‹è½½å¤±è´¥');
        }
      }

      showProgress() {
        document.getElementById('progressContainer').style.display = 'block';
      }

      hideProgress() {
        document.getElementById('progressContainer').style.display = 'none';
      }

      updateProgress(text, percentage) {
        document.getElementById('progressText').textContent = text;
        document.getElementById('progressFill').style.width = `${percentage}%`;
      }

      showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }

      showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 5000);
      }

      hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    document.addEventListener('DOMContentLoaded', () => {
      new ExcelTranslator();
    });
  </script>
</body>
</html>