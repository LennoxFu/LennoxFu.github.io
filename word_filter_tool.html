<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å•è¯ç­›é€‰å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      text-align: center;
      max-width: 600px;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 24px 24px 0 0;
    }

    h1 {
      color: #2d3748;
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .upload-section {
      background: #f7fafc;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px dashed #cbd5e0;
      transition: all 0.3s ease;
    }

    .upload-section:hover {
      border-color: #667eea;
      background: #f1f5f9;
    }

    .upload-section.dragover {
      border-color: #4facfe;
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin: 20px 0;
    }

    .file-input {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }

    .file-input-label {
      display: inline-block;
      padding: 16px 32px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .file-input-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .file-info {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      color: #4a5568;
      font-weight: 500;
    }

    .word-count-info {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      display: inline-block;
      margin: 15px 0;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    .options-section {
      background: #f7fafc;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e2e8f0;
    }

    .options-section h4 {
      color: #2d3748;
      margin-bottom: 15px;
      font-size: 1.1em;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #667eea;
    }

    .checkbox-wrapper label {
      color: #4a5568;
      font-weight: 500;
      cursor: pointer;
    }

    .word-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 40px 20px;
      margin: 30px 0;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-height: 160px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
    }

    .word-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    #word {
      font-size: 3em;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
      letter-spacing: 1px;
      transition: all 0.4s ease;
    }

    #word.highlight {
      transform: scale(1.1);
      color: #667eea;
    }

    #meaning {
      font-size: 1.3em;
      color: #718096;
      font-weight: 500;
      margin-top: 15px;
      opacity: 0.9;
    }

    .timer-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff6b6b, #feca57);
      border-radius: 0 0 16px 16px;
      width: 100%;
      transition: width 5s linear;
    }

    .buttons-container {
      margin: 40px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
    }

    button {
      padding: 16px 32px;
      font-size: 1.1em;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      min-width: 120px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .start-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      font-size: 1.2em;
      padding: 18px 36px;
    }

    .shuffle-btn {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #333;
      font-size: 1em;
      padding: 12px 24px;
      margin: 10px;
    }

    .export-btn {
      background: linear-gradient(135deg, #a8edea, #fed6e3);
      color: #333;
      font-size: 1em;
      padding: 12px 24px;
      margin: 10px;
    }

    .familiar {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
    }

    .unfamiliar {
      background: linear-gradient(135deg, #f093fb, #f5576c);
    }

    .vague {
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      color: #333;
    }

    .match {
      background: linear-gradient(135deg, #a8edea, #fed6e3);
      color: #333;
    }

    .diff {
      background: linear-gradient(135deg, #d299c2, #fef9d7);
      color: #333;
    }

    .round-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(102, 126, 234, 0.2);
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    #result {
      margin-top: 30px;
      text-align: left;
      background: #f7fafc;
      border-radius: 16px;
      padding: 30px;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #result h3 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-align: center;
    }

    #result p {
      margin: 15px 0;
      padding: 12px 16px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid;
      font-size: 1.1em;
      line-height: 1.6;
    }

    #result p:nth-child(2) { border-left-color: #4facfe; }
    #result p:nth-child(3) { border-left-color: #f093fb; }
    #result p:nth-child(4) { border-left-color: #a8edea; }
    #result p:nth-child(5) { border-left-color: #d299c2; }

    .word-count {
      display: inline-block;
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 600;
      margin-left: 10px;
    }

    .celebration {
      animation: celebration 0.6s ease-out;
    }

    @keyframes celebration {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .error-message {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }

    .success-message {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }

    .excel-format-info {
      background: #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      font-size: 0.95em;
      color: #4a5568;
      text-align: left;
    }

    .excel-format-info h4 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .shuffle-indicator {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #333;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
      margin: 10px 0;
      display: inline-block;
    }

    @media (max-width: 768px) {
      .container {
        padding: 30px 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 2em;
        margin-bottom: 30px;
      }
      
      #word {
        font-size: 2.2em;
      }
      
      .buttons-container {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 100%;
        max-width: 250px;
      }

      .upload-section {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="round-indicator" id="roundIndicator" style="display: none;">ç¬¬1è½®</div>
    <h1>ğŸ¯ å•è¯ç­›é€‰å·¥å…·</h1>

    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-section" id="uploadSection">
      <h3 style="color: #4a5568; margin-bottom: 20px;">ğŸ“ ä¸Šä¼ ä½ çš„å•è¯åˆ—è¡¨</h3>
      
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="handleFile(event)">
        <label for="fileInput" class="file-input-label">
          ğŸ“¤ é€‰æ‹©Excelæ–‡ä»¶
        </label>
      </div>
      
      <div class="excel-format-info">
        <h4>ğŸ“‹ Excelæ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
        <p>â€¢ ç¬¬ä¸€åˆ—ï¼šè‹±è¯­å•è¯ (å¦‚ï¼šabandon, abstract, ...)</p>
        <p>â€¢ ç¬¬äºŒåˆ—ï¼šä¸­æ–‡é‡Šä¹‰ (å¦‚ï¼šæ”¾å¼ƒ, æŠ½è±¡çš„, ...)</p>
        <p>â€¢ æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
        <p>â€¢ ç¬¬ä¸€è¡Œå¯ä»¥æ˜¯æ ‡é¢˜è¡Œï¼Œç¨‹åºä¼šè‡ªåŠ¨è¯†åˆ«</p>
      </div>
      
      <div id="fileInfo" class="file-info" style="display: none;"></div>
      <div id="wordCountInfo" class="word-count-info" style="display: none;"></div>
      <div id="uploadMessage"></div>
      
      <!-- æµ‹è¯•é€‰é¡¹ -->
      <div class="options-section">
        <h4>âš™ï¸ æµ‹è¯•é€‰é¡¹</h4>
        <div class="checkbox-wrapper">
          <input type="checkbox" id="shuffleOption" checked>
          <label for="shuffleOption">ğŸ”€ éšæœºæ‰“ä¹±å•è¯é¡ºåº</label>
        </div>
      </div>
    </div>

    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div id="shuffleIndicator" class="shuffle-indicator" style="display: none;">
      ğŸ”€ å•è¯é¡ºåºå·²éšæœºæ‰“ä¹±
    </div>

    <div class="word-card" style="display: none;">
      <div id="word">ç‚¹å‡»å¼€å§‹æµ‹è¯•</div>
      <div id="meaning"></div>
      <div class="timer-bar" id="timerBar"></div>
    </div>

    <div class="buttons-container">
      <button class="start-btn" onclick="start()" id="startBtn" disabled>ğŸš€ å¼€å§‹æµ‹è¯•</button>
      <button class="familiar" onclick="classify('familiar')" style="display: none;">âœ… ç†Ÿæ‚‰</button>
      <button class="unfamiliar" onclick="classify('unfamiliar')" style="display: none;">âŒ ä¸ç†Ÿ</button>
      <button class="vague" onclick="classify('vague')" style="display: none;">â“ æ¨¡ç³Š</button>
      <button class="match" onclick="classify('match')" style="display:none;">âœ… æ¨¡ç³Šä½†åŒ¹é…</button>
      <button class="diff" onclick="classify('diff')" style="display:none;">âŒ æ¨¡ç³Šä¸”å·®å¼‚</button>
    </div>

    <div id="result"></div>
  </div>

  <!-- å¼•å…¥ SheetJS åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // é»˜è®¤å•è¯åˆ—è¡¨ï¼ˆä½œä¸ºç¤ºä¾‹ï¼‰
    const defaultWords = [
      {en:"abandon", zh:"æ”¾å¼ƒ"},
      {en:"abstract", zh:"æŠ½è±¡çš„"},
      {en:"accelerate", zh:"åŠ é€Ÿ"},
      {en:"accessible", zh:"å¯æ¥è¿‘çš„"},
      {en:"accompany", zh:"é™ªä¼´"},
      {en:"accomplish", zh:"å®Œæˆ"},
      {en:"account", zh:"è´¦æˆ·ï¼›è§£é‡Š"},
      {en:"accumulate", zh:"ç§¯ç´¯"},
      {en:"accurate", zh:"å‡†ç¡®çš„"},
      {en:"accuse", zh:"æŒ‡æ§"}
    ];

    let words = []; // å½“å‰ä½¿ç”¨çš„å•è¯åˆ—è¡¨
    let originalWords = []; // ä¿å­˜åŸå§‹å•è¯åˆ—è¡¨
    let familiar = [], unfamiliar = [], vague = [], vagueMatch = [], vagueDiff = [];
    let index = 0, round = 1, timer;

    // éšæœºæ‰“ä¹±æ•°ç»„çš„å‡½æ•°
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const uploadSection = document.getElementById('uploadSection');
    uploadSection.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadSection.classList.add('dragover');
    });

    uploadSection.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadSection.classList.remove('dragover');
    });

    uploadSection.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadSection.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.match(/\.(xlsx|xls)$/i)) {
          processExcelFile(file);
        } else {
          showMessage('è¯·ä¸Šä¼ Excelæ–‡ä»¶ (.xlsx æˆ– .xls)', 'error');
        }
      }
    });

    function handleFile(event) {
      const file = event.target.files[0];
      if (file) {
        processExcelFile(file);
      }
    }

    function processExcelFile(file) {
      showMessage('æ­£åœ¨è§£æExcelæ–‡ä»¶...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // è§£ææ•°æ®
          const parsedWords = parseWordsFromExcel(jsonData);
          
          if (parsedWords.length === 0) {
            showMessage('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ•°æ®', 'error');
            return;
          }
          
          originalWords = parsedWords;
          words = [...originalWords];
          
          // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          document.getElementById('fileInfo').style.display = 'block';
          document.getElementById('fileInfo').innerHTML = `âœ… æ–‡ä»¶å·²ä¸Šä¼ ï¼š${file.name}`;
          
          document.getElementById('wordCountInfo').style.display = 'block';
          document.getElementById('wordCountInfo').innerHTML = `ğŸ“š å…±åŠ è½½ ${words.length} ä¸ªå•è¯`;
          
          // å¯ç”¨å¼€å§‹æŒ‰é’®
          document.getElementById('startBtn').disabled = false;
          
          showMessage('Excelæ–‡ä»¶è§£ææˆåŠŸï¼', 'success');
          
        } catch (error) {
          console.error('Excelè§£æé”™è¯¯:', error);
          showMessage('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    function parseWordsFromExcel(jsonData) {
      const parsedWords = [];
      let startRow = 0;
      
      // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä¸ºæ ‡é¢˜è¡Œ
      if (jsonData.length > 0) {
        const firstRow = jsonData[0];
        if (firstRow && firstRow.length >= 2) {
          // å¦‚æœç¬¬ä¸€è¡Œçœ‹èµ·æ¥åƒæ ‡é¢˜ï¼Œå°±è·³è¿‡å®ƒ
          const firstCellStr = String(firstRow[0]).toLowerCase();
          const secondCellStr = String(firstRow[1]).toLowerCase();
          if (firstCellStr.includes('è‹±') || firstCellStr.includes('english') || firstCellStr.includes('word') ||
              secondCellStr.includes('ä¸­') || secondCellStr.includes('chinese') || secondCellStr.includes('æ„æ€')) {
            startRow = 1;
          }
        }
      }
      
      // è§£ææ•°æ®è¡Œ
      for (let i = startRow; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row && row.length >= 2 && row[0] && row[1]) {
          const en = String(row[0]).trim();
          const zh = String(row[1]).trim();
          
          // éªŒè¯è‹±è¯­å•è¯æ ¼å¼ï¼ˆåŸºæœ¬çš„å­—æ¯æ£€æŸ¥ï¼‰
          if (en && zh && /^[a-zA-Z\s\-\.]+$/.test(en)) {
            parsedWords.push({ en, zh });
          }
        }
      }
      
      return parsedWords;
    }

    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('uploadMessage');
      let className = 'success-message';
      
      if (type === 'error') {
        className = 'error-message';
      } else if (type === 'info') {
        className = 'success-message';
      }
      
      messageDiv.innerHTML = `<div class="${className}">${text}</div>`;
      
      // 3ç§’åæ¸…é™¤æ¶ˆæ¯
      setTimeout(() => {
        messageDiv.innerHTML = '';
      }, 3000);
    }

    function start() {
      if (words.length === 0) {
        showMessage('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶æˆ–ä½¿ç”¨é»˜è®¤å•è¯åˆ—è¡¨', 'error');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦éšæœºæ‰“ä¹±
      if (document.getElementById('shuffleOption').checked) {
        words = shuffleArray(originalWords.length > 0 ? originalWords : defaultWords);
        document.getElementById('shuffleIndicator').style.display = 'block';
      } else {
        words = [...(originalWords.length > 0 ? originalWords : defaultWords)];
        document.getElementById('shuffleIndicator').style.display = 'none';
      }
      
      index = 0; round = 1;
      familiar = []; unfamiliar = []; vague = []; vagueMatch = []; vagueDiff = [];
      document.getElementById("result").innerHTML = "";
      document.getElementById("roundIndicator").innerText = "ç¬¬1è½®";
      document.getElementById("roundIndicator").style.display = "block";
      
      // éšè—ä¸Šä¼ åŒºåŸŸï¼Œæ˜¾ç¤ºæµ‹è¯•åŒºåŸŸ
      document.getElementById('uploadSection').style.display = 'none';
      document.querySelector('.word-card').style.display = 'flex';
      document.querySelector('.progress-bar').style.display = 'block';
      
      updateProgress();
      showWord();
    }

    function updateProgress() {
      const totalWords = round === 1 ? words.length : vague.length;
      const progress = totalWords > 0 ? (index / totalWords) * 100 : 0;
      document.getElementById("progressFill").style.width = progress + "%";
    }

    function resetTimerBar() {
      const timerBar = document.getElementById("timerBar");
      // ç«‹å³è®¾ç½®ä¸º100%å®½åº¦ï¼Œæ— åŠ¨ç”»
      timerBar.style.transition = 'none';
      timerBar.style.width = '100%';
      // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜
      timerBar.offsetHeight;
    }

    function startTimerBar() {
      const timerBar = document.getElementById("timerBar");
      // åœ¨ä¸‹ä¸€å¸§å¼€å§‹åŠ¨ç”»
      requestAnimationFrame(() => {
        timerBar.style.transition = 'width 5s linear';
        timerBar.style.width = '0%';
      });
    }

    function showWord() {
      clearTimeout(timer);
      resetTimerBar(); // é‡ç½®è®¡æ—¶å™¨æ¡
      
      if (round === 1 && index >= words.length) {
        // ç¬¬ä¸€è½®ç»“æŸï¼Œè¿›å…¥ç¬¬äºŒè½®å¤ç›˜
        index = 0; round = 2;
        document.getElementById("roundIndicator").innerText = "ç¬¬2è½®";
        if (vague.length === 0) {
          finish();
          return;
        }
        document.getElementById("word").innerText = "ğŸ”„ è¿›å…¥æ¨¡ç³Šå•è¯å¤ç›˜";
        document.getElementById("word").classList.add("highlight");
        setTimeout(() => {
          document.getElementById("word").classList.remove("highlight");
          showWord();
        }, 1500);
        return;
      }
      
      if (round === 2 && index >= vague.length) {
        finish();
        return;
      }

      let wordObj = (round === 1 ? words[index] : vague[index]);
      document.getElementById("word").innerText = wordObj.en;
      document.getElementById("meaning").innerText = (round === 2 ? wordObj.zh : "");
      
      // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
      document.querySelectorAll(".familiar,.unfamiliar,.vague").forEach(b => 
        b.style.display = (round === 1 ? "inline-block" : "none")
      );
      document.querySelectorAll(".match,.diff").forEach(b => 
        b.style.display = (round === 2 ? "inline-block" : "none")
      );
      document.querySelector(".start-btn").style.display = "none";
      
      updateProgress();

      if (round === 1) {
        // å¯åŠ¨5ç§’è®¡æ—¶å™¨æ¡åŠ¨ç”»
        startTimerBar();
        timer = setTimeout(() => classify('vague'), 5000);
      }
    }

    function classify(type) {
      clearTimeout(timer);
      resetTimerBar(); // ç«‹å³é‡ç½®è®¡æ—¶å™¨æ¡
      
      let wordObj = (round === 1 ? words[index] : vague[index]);

      if (round === 1) {
        if (type === 'familiar') familiar.push(wordObj);
        else if (type === 'unfamiliar') unfamiliar.push(wordObj);
        else if (type === 'vague') vague.push(wordObj);
      } else {
        if (type === 'match') vagueMatch.push(wordObj);
        else if (type === 'diff') vagueDiff.push(wordObj);
      }

      // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
      document.querySelector(".word-card").classList.add("celebration");
      setTimeout(() => {
        document.querySelector(".word-card").classList.remove("celebration");
      }, 600);

      index++;
      setTimeout(showWord, 300);
    }

    // å¯¼å‡ºç»“æœåˆ°Excel
    function exportResults() {
      if (familiar.length === 0 && unfamiliar.length === 0 && vagueMatch.length === 0 && vagueDiff.length === 0) {
        showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ', 'error');
        return;
      }

      try {
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // åˆ›å»ºæ±‡æ€»å·¥ä½œè¡¨
        const summaryData = [
          ['åˆ†ç±»', 'å•è¯æ•°é‡', 'å•è¯åˆ—è¡¨'],
          ['ç†Ÿæ‚‰å•è¯', familiar.length, familiar.map(w => w.en).join(', ')],
          ['ä¸ç†Ÿå•è¯', unfamiliar.length, unfamiliar.map(w => w.en).join(', ')],
          ['æ¨¡ç³Š-åŒ¹é…', vagueMatch.length, vagueMatch.map(w => w.en).join(', ')],
          ['æ¨¡ç³Š-å·®å¼‚', vagueDiff.length, vagueDiff.map(w => w.en).join(', ')]
        ];
        const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summaryWs, 'ç­›é€‰æ±‡æ€»');

        // åˆ›å»ºè¯¦ç»†åˆ†ç±»å·¥ä½œè¡¨
        const categories = [
          { name: 'ç†Ÿæ‚‰å•è¯', data: familiar, sheetName: 'ç†Ÿæ‚‰å•è¯' },
          { name: 'ä¸ç†Ÿå•è¯', data: unfamiliar, sheetName: 'ä¸ç†Ÿå•è¯' },
          { name: 'æ¨¡ç³Š-åŒ¹é…', data: vagueMatch, sheetName: 'æ¨¡ç³ŠåŒ¹é…' },
          { name: 'æ¨¡ç³Š-å·®å¼‚', data: vagueDiff, sheetName: 'æ¨¡ç³Šå·®å¼‚' }
        ];

        categories.forEach(category => {
          if (category.data.length > 0) {
            const categoryData = [['è‹±è¯­å•è¯', 'ä¸­æ–‡é‡Šä¹‰']];
            category.data.forEach(word => {
              categoryData.push([word.en, word.zh]);
            });
            const categoryWs = XLSX.utils.aoa_to_sheet(categoryData);
            XLSX.utils.book_append_sheet(wb, categoryWs, category.sheetName);
          }
        });

        // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `å•è¯ç­›é€‰ç»“æœ_${timestamp}.xlsx`;

        // ä¸‹è½½æ–‡ä»¶
        XLSX.writeFile(wb, filename);
        
        showMessage('ç»“æœå·²æˆåŠŸå¯¼å‡ºåˆ°Excelæ–‡ä»¶ï¼', 'success');
        
      } catch (error) {
        console.error('å¯¼å‡ºé”™è¯¯:', error);
        showMessage('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    function finish() {
      document.getElementById("word").innerText = "ğŸ‰ ç­›é€‰å®Œæˆï¼";
      document.getElementById("meaning").innerText = "";
      document.getElementById("roundIndicator").style.display = "none";
      document.getElementById("shuffleIndicator").style.display = "none";
      document.querySelectorAll("button").forEach(b => b.style.display = "none");
      document.querySelector(".progress-bar").style.display = "none";
      resetTimerBar(); // ç¡®ä¿è®¡æ—¶å™¨æ¡è¢«é‡ç½®
      
      let resultHTML = "<h3>ğŸ“Š ç»“æœç»Ÿè®¡</h3>";
      resultHTML += `<p><strong>âœ… ç†Ÿæ‚‰å•è¯:</strong> ${familiar.map(w=>w.en).join(", ")} <span class="word-count">${familiar.length}ä¸ª</span></p>`;
      resultHTML += `<p><strong>âŒ ä¸ç†Ÿå•è¯:</strong> ${unfamiliar.map(w=>w.en).join(", ")} <span class="word-count">${unfamiliar.length}ä¸ª</span></p>`;
      resultHTML += `<p><strong>âœ… æ¨¡ç³Š-åŒ¹é…:</strong> ${vagueMatch.map(w=>w.en).join(", ")} <span class="word-count">${vagueMatch.length}ä¸ª</span></p>`;
      resultHTML += `<p><strong>âŒ æ¨¡ç³Š-å·®å¼‚:</strong> ${vagueDiff.map(w=>w.en).join(", ")} <span class="word-count">${vagueDiff.length}ä¸ª</span></p>`;
      
      // æ·»åŠ å¯¼å‡ºå’Œé‡æ–°å¼€å§‹æŒ‰é’®
      resultHTML += `<div style="text-align: center; margin-top: 30px;">
        <button class="export-btn" onclick="exportResults()" style="display: inline-block;">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
        <button class="start-btn" onclick="resetToUpload()" style="display: inline-block;">ğŸ”„ é‡æ–°å¼€å§‹</button>
      </div>`;
      
      document.getElementById("result").innerHTML = resultHTML;
      document.getElementById("result").classList.add("fade-in");
    }

    function resetToUpload() {
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      words = [];
      originalWords = [];
      familiar = []; unfamiliar = []; vague = []; vagueMatch = []; vagueDiff = [];
      index = 0; round = 1;
      clearTimeout(timer);
      resetTimerBar();
      
      // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸï¼Œéšè—å…¶ä»–åŒºåŸŸ
      document.getElementById('uploadSection').style.display = 'block';
      document.querySelector('.word-card').style.display = 'none';
      document.querySelector('.progress-bar').style.display = 'none';
      document.getElementById("result").innerHTML = "";
      document.getElementById("roundIndicator").style.display = "none";
      document.getElementById("shuffleIndicator").style.display = "none";
      
      // é‡ç½®æŒ‰é’®æ˜¾ç¤º
      document.querySelector(".start-btn").style.display = "inline-block";
      document.querySelector(".start-btn").disabled = true;
      document.querySelectorAll(".familiar,.unfamiliar,.vague,.match,.diff").forEach(b => 
        b.style.display = "none"
      );
      
      // æ¸…ç©ºæ–‡ä»¶ä¿¡æ¯
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('wordCountInfo').style.display = 'none';
      document.getElementById('fileInput').value = '';
      
      // é‡ç½®å¤é€‰æ¡†
      document.getElementById('shuffleOption').checked = true;
    }

    // é¡µé¢åŠ è½½æ—¶ä½¿ç”¨é»˜è®¤å•è¯åˆ—è¡¨ä½œä¸ºç¤ºä¾‹
    window.onload = function() {
      originalWords = [...defaultWords];
      words = [...defaultWords];
      document.getElementById('wordCountInfo').style.display = 'block';
      document.getElementById('wordCountInfo').innerHTML = `ğŸ“š å½“å‰ä½¿ç”¨ç¤ºä¾‹å•è¯åˆ—è¡¨ (${words.length} ä¸ªå•è¯)`;
      document.getElementById('startBtn').disabled = false;
      showMessage('å¯ä»¥ç›´æ¥å¼€å§‹æµ‹è¯•ç¤ºä¾‹å•è¯ï¼Œæˆ–ä¸Šä¼ è‡ªå·±çš„Excelæ–‡ä»¶', 'success');
    };
  </script>

</body>
</html>